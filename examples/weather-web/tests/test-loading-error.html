<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading States & Error Handling Tests - Weather Web</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/components.css">
    <style>
        .test-results { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
        }
        .test-pass { color: green; }
        .test-fail { color: red; }
        .test-section { margin: 20px 0; padding: 10px; border: 1px solid #eee; }
        .demo-container { margin: 20px 0; padding: 20px; border: 2px solid #ddd; }
        .demo-controls { margin-bottom: 20px; }
        .demo-controls button { margin-right: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="test-results">
        <h1>Loading States & Error Handling Tests</h1>
        <div id="test-output"></div>
        <button onclick="runAllTests()">Run Tests</button>
    </div>

    <!-- Demo Controls -->
    <div class="demo-container">
        <h2>Component Demos</h2>
        <div class="demo-controls">
            <button onclick="testLoadingSpinner()">Test Loading Spinner</button>
            <button onclick="testSkeletonUI()">Test Skeleton UI</button>
            <button onclick="testErrorMessage()">Test Error Message</button>
            <button onclick="testProgressIndicator()">Test Progress Indicator</button>
            <button onclick="testRetryMechanism()">Test Retry Mechanism</button>
            <button onclick="clearDemo()">Clear Demo</button>
        </div>
        <div id="demo-area" style="min-height: 200px; border: 1px solid #ccc; padding: 20px;"></div>
    </div>

    <!-- Test containers -->
    <div style="display: none;">
        <div id="spinner-test-container"></div>
        <div id="error-test-container"></div>
        <div id="skeleton-test-container"></div>
    </div>

    <script type="module">
        // Test framework
        class LoadingErrorTestRunner {
            constructor() {
                this.tests = [];
                this.output = document.getElementById('test-output');
                this.demoArea = document.getElementById('demo-area');
            }

            test(name, fn) {
                this.tests.push({ name, fn });
            }

            async run() {
                this.output.innerHTML = '';
                let passed = 0;
                let failed = 0;

                for (const test of this.tests) {
                    try {
                        await test.fn();
                        this.log(`✓ ${test.name}`, 'test-pass');
                        passed++;
                    } catch (error) {
                        this.log(`✗ ${test.name}: ${error.message}`, 'test-fail');
                        console.error(error);
                        failed++;
                    }
                }

                this.log(`\nResults: ${passed} passed, ${failed} failed`, 
                         failed === 0 ? 'test-pass' : 'test-fail');
            }

            log(message, className = '') {
                const div = document.createElement('div');
                div.textContent = message;
                div.className = className;
                this.output.appendChild(div);
            }

            assert(condition, message) {
                if (!condition) {
                    throw new Error(message);
                }
            }

            assertEqual(actual, expected, message) {
                if (actual !== expected) {
                    throw new Error(`${message}: expected ${expected}, got ${actual}`);
                }
            }

            assertContains(str, substring, message) {
                if (!str.includes(substring)) {
                    throw new Error(`${message}: expected "${str}" to contain "${substring}"`);
                }
            }

            async wait(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        const runner = new LoadingErrorTestRunner();

        // LoadingSpinner Component Tests
        runner.test('LoadingSpinner class can be imported and instantiated', async () => {
            const LoadingSpinner = (await import('../js/components/loadingSpinner.js')).default;
            runner.assert(LoadingSpinner, 'LoadingSpinner should be importable');

            const container = document.getElementById('spinner-test-container');
            const spinner = new LoadingSpinner(container);
            runner.assert(spinner, 'LoadingSpinner should be instantiable');
        });

        runner.test('LoadingSpinner renders with default options', async () => {
            const LoadingSpinner = (await import('../js/components/loadingSpinner.js')).default;
            const container = document.getElementById('spinner-test-container');
            container.innerHTML = '';
            
            const spinner = new LoadingSpinner(container);
            spinner.show();
            
            const spinnerElement = container.querySelector('.loading-spinner');
            runner.assert(spinnerElement, 'Should create spinner element');
            
            const isVisible = spinnerElement.style.display !== 'none' && 
                            !spinnerElement.hidden;
            runner.assert(isVisible, 'Spinner should be visible when shown');
        });

        runner.test('LoadingSpinner can be customized with options', async () => {
            const LoadingSpinner = (await import('../js/components/loadingSpinner.js')).default;
            const container = document.getElementById('spinner-test-container');
            container.innerHTML = '';
            
            const spinner = new LoadingSpinner(container, {
                size: 'large',
                text: 'Custom loading text',
                color: '#ff0000'
            });
            spinner.show();
            
            const text = container.querySelector('.loading-text');
            runner.assert(text && text.textContent === 'Custom loading text', 
                'Should display custom loading text');
            
            const spinnerElement = container.querySelector('.loading-spinner');
            runner.assert(spinnerElement.classList.contains('loading-spinner--large'), 
                'Should apply size class');
        });

        runner.test('LoadingSpinner can be hidden', async () => {
            const LoadingSpinner = (await import('../js/components/loadingSpinner.js')).default;
            const container = document.getElementById('spinner-test-container');
            container.innerHTML = '';
            
            const spinner = new LoadingSpinner(container);
            spinner.show();
            spinner.hide();
            
            const spinnerContainer = container.querySelector('.loading-container');
            runner.assert(spinnerContainer.hidden || 
                         spinnerContainer.style.display === 'none', 
                'Spinner should be hidden');
        });

        runner.test('LoadingSpinner supports different types', async () => {
            const LoadingSpinner = (await import('../js/components/loadingSpinner.js')).default;
            const container = document.getElementById('spinner-test-container');
            container.innerHTML = '';
            
            const types = ['spinner', 'dots', 'bars', 'pulse'];
            
            for (const type of types) {
                const spinner = new LoadingSpinner(container, { type });
                spinner.show();
                
                const element = container.querySelector(`.loading-${type}`) || 
                              container.querySelector('.loading-spinner');
                runner.assert(element, `Should create ${type} loading indicator`);
                
                spinner.hide();
            }
        });

        // ErrorMessage Component Tests
        runner.test('ErrorMessage class can be imported and instantiated', async () => {
            const ErrorMessage = (await import('../js/components/errorMessage.js')).default;
            runner.assert(ErrorMessage, 'ErrorMessage should be importable');

            const container = document.getElementById('error-test-container');
            const errorMsg = new ErrorMessage(container);
            runner.assert(errorMsg, 'ErrorMessage should be instantiable');
        });

        runner.test('ErrorMessage displays error with title and description', async () => {
            const ErrorMessage = (await import('../js/components/errorMessage.js')).default;
            const container = document.getElementById('error-test-container');
            container.innerHTML = '';
            
            const errorMsg = new ErrorMessage(container);
            errorMsg.show('Network Error', 'Unable to connect to weather service');
            
            const titleElement = container.querySelector('.error-title');
            const messageElement = container.querySelector('.error-message');
            
            runner.assert(titleElement && titleElement.textContent === 'Network Error', 
                'Should display error title');
            runner.assert(messageElement && messageElement.textContent === 'Unable to connect to weather service', 
                'Should display error message');
        });

        runner.test('ErrorMessage supports different error types', async () => {
            const ErrorMessage = (await import('../js/components/errorMessage.js')).default;
            const container = document.getElementById('error-test-container');
            container.innerHTML = '';
            
            const errorMsg = new ErrorMessage(container);
            
            const errorTypes = [
                { type: 'network', expectedClass: 'error-message--network' },
                { type: 'validation', expectedClass: 'error-message--validation' },
                { type: 'server', expectedClass: 'error-message--server' },
                { type: 'generic', expectedClass: 'error-message--generic' }
            ];
            
            for (const { type, expectedClass } of errorTypes) {
                errorMsg.show('Test Error', 'Test message', { type });
                const errorContainer = container.querySelector('.error-container');
                runner.assert(errorContainer.classList.contains(expectedClass), 
                    `Should apply ${expectedClass} for ${type} error`);
            }
        });

        runner.test('ErrorMessage shows retry button when enabled', async () => {
            const ErrorMessage = (await import('../js/components/errorMessage.js')).default;
            const container = document.getElementById('error-test-container');
            container.innerHTML = '';
            
            let retryClicked = false;
            const errorMsg = new ErrorMessage(container, {
                showRetry: true,
                onRetry: () => { retryClicked = true; }
            });
            
            errorMsg.show('Test Error', 'Test message');
            
            const retryButton = container.querySelector('.retry-btn');
            runner.assert(retryButton, 'Should show retry button');
            
            retryButton.click();
            runner.assert(retryClicked, 'Should call retry callback when clicked');
        });

        runner.test('ErrorMessage can be hidden', async () => {
            const ErrorMessage = (await import('../js/components/errorMessage.js')).default;
            const container = document.getElementById('error-test-container');
            container.innerHTML = '';
            
            const errorMsg = new ErrorMessage(container);
            errorMsg.show('Test Error', 'Test message');
            errorMsg.hide();
            
            const errorContainer = container.querySelector('.error-container');
            runner.assert(errorContainer.hidden || 
                         errorContainer.style.display === 'none', 
                'Error message should be hidden');
        });

        runner.test('ErrorMessage supports auto-dismiss', async () => {
            const ErrorMessage = (await import('../js/components/errorMessage.js')).default;
            const container = document.getElementById('error-test-container');
            container.innerHTML = '';
            
            const errorMsg = new ErrorMessage(container, {
                autoDismiss: 1000 // 1 second
            });
            
            errorMsg.show('Test Error', 'Test message');
            
            const errorContainer = container.querySelector('.error-container');
            runner.assert(!errorContainer.hidden, 'Should be visible initially');
            
            await runner.wait(1100); // Wait for auto-dismiss
            
            runner.assert(errorContainer.hidden || 
                         errorContainer.style.display === 'none', 
                'Should auto-dismiss after timeout');
        });

        // Skeleton UI Tests
        runner.test('Skeleton UI can be created for weather card', async () => {
            const LoadingSpinner = (await import('../js/components/loadingSpinner.js')).default;
            const container = document.getElementById('skeleton-test-container');
            container.innerHTML = '';
            
            const spinner = new LoadingSpinner(container, { 
                type: 'skeleton',
                skeletonType: 'weather-card' 
            });
            spinner.show();
            
            const skeleton = container.querySelector('.skeleton-weather-card');
            runner.assert(skeleton, 'Should create weather card skeleton');
            
            const skeletonElements = container.querySelectorAll('.skeleton-item');
            runner.assert(skeletonElements.length > 0, 'Should have skeleton items');
        });

        runner.test('Skeleton UI can be created for forecast grid', async () => {
            const LoadingSpinner = (await import('../js/components/loadingSpinner.js')).default;
            const container = document.getElementById('skeleton-test-container');
            container.innerHTML = '';
            
            const spinner = new LoadingSpinner(container, { 
                type: 'skeleton',
                skeletonType: 'forecast-grid' 
            });
            spinner.show();
            
            const skeleton = container.querySelector('.skeleton-forecast-grid');
            runner.assert(skeleton, 'Should create forecast grid skeleton');
            
            const skeletonItems = container.querySelectorAll('.skeleton-forecast-item');
            runner.assert(skeletonItems.length > 0, 'Should have skeleton forecast items');
        });

        // Progress Indicator Tests
        runner.test('Progress indicator shows loading stages', async () => {
            const LoadingSpinner = (await import('../js/components/loadingSpinner.js')).default;
            const container = document.getElementById('spinner-test-container');
            container.innerHTML = '';
            
            const spinner = new LoadingSpinner(container, { 
                type: 'progress',
                showStages: true
            });
            
            spinner.show('Connecting to weather service...');
            let progressText = container.querySelector('.loading-text').textContent;
            runner.assertContains(progressText, 'Connecting', 'Should show connecting stage');
            
            spinner.updateProgress(50, 'Fetching weather data...');
            progressText = container.querySelector('.loading-text').textContent;
            runner.assertContains(progressText, 'Fetching', 'Should show fetching stage');
            
            const progressBar = container.querySelector('.progress-bar');
            runner.assert(progressBar, 'Should show progress bar');
        });

        // Integration Tests
        runner.test('Components work together for complete loading flow', async () => {
            const LoadingSpinner = (await import('../js/components/loadingSpinner.js')).default;
            const ErrorMessage = (await import('../js/components/errorMessage.js')).default;
            const container = document.createElement('div');
            
            // Start with loading
            const spinner = new LoadingSpinner(container);
            spinner.show('Loading weather data...');
            
            let hasSpinner = container.querySelector('.loading-spinner');
            runner.assert(hasSpinner, 'Should show loading spinner initially');
            
            // Simulate error
            spinner.hide();
            const errorMsg = new ErrorMessage(container, { showRetry: true });
            errorMsg.show('Network Error', 'Failed to load weather data');
            
            let hasError = container.querySelector('.error-container');
            runner.assert(hasError, 'Should show error message after loading fails');
            
            // Simulate retry
            errorMsg.hide();
            spinner.show('Retrying...');
            
            hasSpinner = container.querySelector('.loading-spinner');
            runner.assert(hasSpinner && !hasSpinner.hidden, 'Should show loading again on retry');
        });

        runner.test('Error handling provides helpful messages for common errors', async () => {
            const ErrorMessage = (await import('../js/components/errorMessage.js')).default;
            const container = document.getElementById('error-test-container');
            container.innerHTML = '';
            
            const errorMsg = new ErrorMessage(container);
            
            // Test common error scenarios
            const scenarios = [
                { 
                    error: new Error('Failed to fetch'), 
                    expectedTitle: 'Connection Error',
                    expectedType: 'network'
                },
                { 
                    error: { status: 404 }, 
                    expectedTitle: 'Location Not Found',
                    expectedType: 'validation'
                },
                { 
                    error: { status: 500 }, 
                    expectedTitle: 'Server Error',
                    expectedType: 'server'
                },
                {
                    error: new Error('Rate limit exceeded'),
                    expectedTitle: 'Rate Limit Exceeded',
                    expectedType: 'server'
                }
            ];
            
            for (const scenario of scenarios) {
                const result = errorMsg.getErrorInfo(scenario.error);
                runner.assertEqual(result.type, scenario.expectedType, 
                    `Should detect ${scenario.expectedType} error type`);
                runner.assertContains(result.title, scenario.expectedTitle, 
                    `Should provide appropriate title for ${scenario.expectedType}`);
            }
        });

        // Accessibility Tests
        runner.test('Loading states are announced to screen readers', async () => {
            const LoadingSpinner = (await import('../js/components/loadingSpinner.js')).default;
            const container = document.getElementById('spinner-test-container');
            container.innerHTML = '';
            
            const spinner = new LoadingSpinner(container, { 
                announceToScreenReader: true 
            });
            spinner.show('Loading weather data...');
            
            const liveRegion = container.querySelector('[aria-live]');
            runner.assert(liveRegion, 'Should create aria-live region for screen readers');
        });

        runner.test('Error messages have proper ARIA attributes', async () => {
            const ErrorMessage = (await import('../js/components/errorMessage.js')).default;
            const container = document.getElementById('error-test-container');
            container.innerHTML = '';
            
            const errorMsg = new ErrorMessage(container);
            errorMsg.show('Test Error', 'Test message');
            
            const errorContainer = container.querySelector('.error-container');
            runner.assert(errorContainer.getAttribute('role') === 'alert', 
                'Error container should have alert role');
            runner.assert(errorContainer.getAttribute('aria-live'), 
                'Error container should have aria-live attribute');
        });

        // Performance Tests
        runner.test('Loading animations are GPU accelerated', async () => {
            const LoadingSpinner = (await import('../js/components/loadingSpinner.js')).default;
            const container = document.getElementById('spinner-test-container');
            container.innerHTML = '';
            
            const spinner = new LoadingSpinner(container);
            spinner.show();
            
            const spinnerElement = container.querySelector('.loading-spinner');
            const computedStyle = getComputedStyle(spinnerElement);
            
            // Check for CSS properties that enable GPU acceleration
            const hasGPUAcceleration = 
                computedStyle.transform !== 'none' ||
                computedStyle.willChange === 'transform' ||
                computedStyle.backfaceVisibility === 'hidden';
                
            runner.assert(hasGPUAcceleration, 
                'Loading animations should use GPU acceleration');
        });

        runner.test('Components clean up properly to prevent memory leaks', async () => {
            const LoadingSpinner = (await import('../js/components/loadingSpinner.js')).default;
            const ErrorMessage = (await import('../js/components/errorMessage.js')).default;
            const container = document.createElement('div');
            
            const spinner = new LoadingSpinner(container);
            const errorMsg = new ErrorMessage(container, { autoDismiss: 100 });
            
            spinner.show();
            errorMsg.show('Test', 'Test');
            
            // Destroy components
            spinner.destroy();
            errorMsg.destroy();
            
            // Check cleanup
            runner.assert(!container.querySelector('.loading-container'), 
                'Should clean up loading elements');
            runner.assert(!container.querySelector('.error-container'), 
                'Should clean up error elements');
        });

        // Demo functions
        window.testLoadingSpinner = async function() {
            const LoadingSpinner = (await import('../js/components/loadingSpinner.js')).default;
            const demoArea = document.getElementById('demo-area');
            demoArea.innerHTML = '';
            
            const spinner = new LoadingSpinner(demoArea, {
                text: 'Loading weather data...',
                type: 'spinner'
            });
            spinner.show();
            
            setTimeout(() => {
                spinner.updateText('Almost done...');
            }, 2000);
        };

        window.testSkeletonUI = async function() {
            const LoadingSpinner = (await import('../js/components/loadingSpinner.js')).default;
            const demoArea = document.getElementById('demo-area');
            demoArea.innerHTML = '';
            
            const skeleton = new LoadingSpinner(demoArea, {
                type: 'skeleton',
                skeletonType: 'weather-card'
            });
            skeleton.show();
        };

        window.testErrorMessage = async function() {
            const ErrorMessage = (await import('../js/components/errorMessage.js')).default;
            const demoArea = document.getElementById('demo-area');
            demoArea.innerHTML = '';
            
            const errorMsg = new ErrorMessage(demoArea, {
                showRetry: true,
                onRetry: () => alert('Retry clicked!')
            });
            errorMsg.show('Network Error', 'Unable to fetch weather data. Please check your internet connection.');
        };

        window.testProgressIndicator = async function() {
            const LoadingSpinner = (await import('../js/components/loadingSpinner.js')).default;
            const demoArea = document.getElementById('demo-area');
            demoArea.innerHTML = '';
            
            const progress = new LoadingSpinner(demoArea, {
                type: 'progress',
                showStages: true
            });
            
            let currentProgress = 0;
            const stages = [
                'Connecting to weather service...',
                'Fetching current weather...',
                'Loading 5-day forecast...',
                'Processing weather data...',
                'Complete!'
            ];
            
            progress.show(stages[0]);
            
            const interval = setInterval(() => {
                currentProgress += 25;
                const stageIndex = Math.min(Math.floor(currentProgress / 25), stages.length - 1);
                progress.updateProgress(currentProgress, stages[stageIndex]);
                
                if (currentProgress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => progress.hide(), 1000);
                }
            }, 1000);
        };

        window.testRetryMechanism = async function() {
            const ErrorMessage = (await import('../js/components/errorMessage.js')).default;
            const demoArea = document.getElementById('demo-area');
            demoArea.innerHTML = '';
            
            let attemptCount = 0;
            const maxAttempts = 3;
            
            const showError = () => {
                attemptCount++;
                const errorMsg = new ErrorMessage(demoArea, {
                    showRetry: attemptCount < maxAttempts,
                    onRetry: () => {
                        errorMsg.hide();
                        setTimeout(() => {
                            if (Math.random() > 0.5) {
                                demoArea.innerHTML = '<div class="success-message">Successfully loaded weather data!</div>';
                            } else {
                                showError();
                            }
                        }, 1000);
                    }
                });
                
                const title = attemptCount >= maxAttempts ? 'Maximum Retries Exceeded' : `Network Error (Attempt ${attemptCount})`;
                const message = attemptCount >= maxAttempts ? 
                    'Unable to connect after multiple attempts. Please try again later.' :
                    'Failed to load weather data. Click retry to try again.';
                    
                errorMsg.show(title, message, { 
                    type: attemptCount >= maxAttempts ? 'server' : 'network' 
                });
            };
            
            showError();
        };

        window.clearDemo = function() {
            document.getElementById('demo-area').innerHTML = '';
        };

        window.runAllTests = function() {
            runner.run();
        };

        // Auto-run tests
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 500);
        });
    </script>
</body>
</html>