<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Icons Integration Tests - Weather Web</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/components.css">
    <style>
        .test-results { font-family: Arial, sans-serif; margin: 20px; }
        .test-pass { color: green; }
        .test-fail { color: red; }
        .test-section { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        .test-info { color: blue; margin: 5px 0; }
        .icon-demo { 
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        .icon-test {
            text-align: center;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            min-width: 80px;
        }
        .icon-test img, .icon-test svg {
            display: block;
            margin: 0 auto 5px;
        }
        .loading-test {
            width: 50px;
            height: 50px;
            background: #f0f0f0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="test-results">
        <h1>Weather Icons Integration Tests</h1>
        <div id="test-output"></div>
        
        <div class="test-section">
            <h2>Icon Integration Demo</h2>
            <div class="icon-demo" id="icon-demo">
                <!-- Icons will be populated by test script -->
            </div>
        </div>

        <div class="test-section">
            <h2>Lazy Loading Test</h2>
            <div id="lazy-loading-test" class="icon-demo">
                <!-- Lazy loaded icons will appear here -->
            </div>
        </div>

        <div class="test-section">
            <h2>Fallback Icons Test</h2>
            <div id="fallback-test" class="icon-demo">
                <!-- Fallback scenarios will be tested here -->
            </div>
        </div>
    </div>

    <script type="module">
        // Test framework
        class TestRunner {
            constructor() {
                this.tests = [];
                this.output = document.getElementById('test-output');
            }

            test(name, fn) {
                this.tests.push({ name, fn });
            }

            async run() {
                let passed = 0;
                let failed = 0;

                for (const test of this.tests) {
                    try {
                        await test.fn();
                        this.log(`✓ ${test.name}`, 'test-pass');
                        passed++;
                    } catch (error) {
                        this.log(`✗ ${test.name}: ${error.message}`, 'test-fail');
                        console.error('Test error:', error);
                        failed++;
                    }
                }

                this.log(`\nResults: ${passed} passed, ${failed} failed`, 
                         failed === 0 ? 'test-pass' : 'test-fail');
            }

            log(message, className = '') {
                const div = document.createElement('div');
                div.textContent = message;
                div.className = className;
                this.output.appendChild(div);
            }

            assert(condition, message) {
                if (!condition) {
                    throw new Error(message);
                }
            }

            assertEqual(actual, expected, message) {
                if (actual !== expected) {
                    throw new Error(`${message}: expected ${expected}, got ${actual}`);
                }
            }

            assertContains(container, selector, message) {
                const element = container.querySelector(selector);
                if (!element) {
                    throw new Error(`${message}: selector ${selector} not found`);
                }
                return element;
            }
        }

        const runner = new TestRunner();

        // Weather Icons Service Tests
        runner.test('WeatherIconService can be imported and instantiated', async () => {
            const module = await import('../js/services/weatherIconService.js');
            const WeatherIconService = module.WeatherIconService || module.default;
            
            const iconService = new WeatherIconService();
            
            runner.assert(iconService instanceof WeatherIconService, 'Should create WeatherIconService instance');
            runner.assert(typeof iconService.getIconUrl === 'function', 'Should have getIconUrl method');
            runner.assert(typeof iconService.createIconElement === 'function', 'Should have createIconElement method');
            runner.assert(typeof iconService.loadIcon === 'function', 'Should have loadIcon method');
            runner.assert(typeof iconService.getSvgFallback === 'function', 'Should have getSvgFallback method');
        });

        runner.test('Icon URL generation works correctly', async () => {
            const module = await import('../js/services/weatherIconService.js');
            const WeatherIconService = module.WeatherIconService || module.default;
            const iconService = new WeatherIconService();
            
            const url = iconService.getIconUrl('01d');
            runner.assert(url.includes('openweathermap.org'), 'Should use OpenWeatherMap domain');
            runner.assert(url.includes('01d'), 'Should include icon code');
            runner.assert(url.includes('@2x'), 'Should include size parameter');
            
            const customSizeUrl = iconService.getIconUrl('01d', '4x');
            runner.assert(customSizeUrl.includes('@4x'), 'Should support custom size');
        });

        runner.test('SVG fallback icons are available', async () => {
            const module = await import('../js/services/weatherIconService.js');
            const WeatherIconService = module.WeatherIconService || module.default;
            const iconService = new WeatherIconService();
            
            const commonIcons = ['01d', '01n', '02d', '03d', '04d', '09d', '10d', '11d', '13d', '50d'];
            
            for (const iconCode of commonIcons) {
                const svg = iconService.getSvgFallback(iconCode);
                runner.assert(svg && svg.includes('<svg'), `Should have SVG fallback for ${iconCode}`);
                runner.assert(svg.includes('viewBox'), 'SVG should have viewBox attribute');
            }
        });

        runner.test('Icon element creation works correctly', async () => {
            const module = await import('../js/services/weatherIconService.js');
            const WeatherIconService = module.WeatherIconService || module.default;
            const iconService = new WeatherIconService();
            
            const iconElement = iconService.createIconElement('01d', 'Clear sky');
            
            runner.assertEqual(iconElement.tagName, 'IMG', 'Should create IMG element');
            runner.assert(iconElement.src.includes('01d'), 'Should set correct src');
            runner.assertEqual(iconElement.alt, 'Clear sky', 'Should set alt text');
            runner.assert(iconElement.className.includes('weather-icon'), 'Should have weather-icon class');
            runner.assert(iconElement.loading === 'lazy', 'Should have lazy loading enabled');
        });

        runner.test('Lazy loading implementation works', async () => {
            const module = await import('../js/services/weatherIconService.js');
            const WeatherIconService = module.WeatherIconService || module.default;
            const iconService = new WeatherIconService();
            
            const container = document.getElementById('lazy-loading-test');
            
            // Create multiple icons for lazy loading test
            const iconCodes = ['01d', '02d', '03d', '04d', '10d'];
            const promises = iconCodes.map(async (code) => {
                const iconDiv = document.createElement('div');
                iconDiv.className = 'icon-test';
                iconDiv.innerHTML = `<div class="loading-test">Loading...</div><div>${code}</div>`;
                container.appendChild(iconDiv);
                
                return iconService.loadIcon(iconDiv, code, `Weather icon ${code}`);
            });
            
            const results = await Promise.all(promises);
            results.forEach((result, index) => {
                runner.assert(result === true, `Icon ${iconCodes[index]} should load successfully`);
            });
        });

        runner.test('Fallback mechanism works when external icons fail', async () => {
            const module = await import('../js/services/weatherIconService.js');
            const WeatherIconService = module.WeatherIconService || module.default;
            const iconService = new WeatherIconService();
            
            const container = document.getElementById('fallback-test');
            
            // Test with invalid icon URL to trigger fallback
            const iconDiv = document.createElement('div');
            iconDiv.className = 'icon-test';
            iconDiv.innerHTML = '<div class="loading-test">Loading...</div><div>Fallback Test</div>';
            container.appendChild(iconDiv);
            
            // Force fallback by using invalid URL
            const result = await iconService.loadIcon(iconDiv, 'invalid-icon', 'Test fallback', {
                forceError: true
            });
            
            runner.assert(result === true, 'Should handle fallback gracefully');
            
            const svg = iconDiv.querySelector('svg');
            runner.assert(svg !== null, 'Should create SVG fallback element');
        });

        runner.test('Icon styling classes are applied correctly', async () => {
            const module = await import('../js/services/weatherIconService.js');
            const WeatherIconService = module.WeatherIconService || module.default;
            const iconService = new WeatherIconService();
            
            const iconElement = iconService.createIconElement('01d', 'Sunny', {
                size: 'large',
                animated: true
            });
            
            runner.assert(iconElement.className.includes('weather-icon--large'), 'Should apply size class');
            runner.assert(iconElement.className.includes('weather-icon--animated'), 'Should apply animation class');
        });

        runner.test('Icon caching works correctly', async () => {
            const module = await import('../js/services/weatherIconService.js');
            const WeatherIconService = module.WeatherIconService || module.default;
            const iconService = new WeatherIconService();
            
            // Load same icon twice
            const iconCode = '01d';
            const firstLoad = await iconService.loadIcon(document.createElement('div'), iconCode, 'Test');
            const secondLoad = await iconService.loadIcon(document.createElement('div'), iconCode, 'Test');
            
            runner.assert(firstLoad === true, 'First load should succeed');
            runner.assert(secondLoad === true, 'Second load should succeed (from cache)');
        });

        // WeatherCard Integration Tests
        runner.test('WeatherCard integrates with icon service', async () => {
            const { WeatherCard } = await import('../js/components/weatherCard.js');
            
            const container = document.createElement('div');
            const weatherCard = new WeatherCard(container);
            
            const mockWeatherData = {
                city: 'London',
                country: 'GB',
                temperature: 20,
                feelsLike: 22,
                description: 'Clear Sky',
                icon: '01d',
                humidity: 65,
                pressure: 1013,
                wind: { speed: 15, direction: 'SW' },
                visibility: 10,
                sunrise: new Date('2024-01-15T07:00:00Z'),
                sunset: new Date('2024-01-15T17:00:00Z'),
                timestamp: new Date()
            };
            
            weatherCard.render(mockWeatherData);
            
            const iconContainer = container.querySelector('.weather-card__icon-container');
            runner.assert(iconContainer !== null, 'Should have icon container');
            
            const iconElement = iconContainer.querySelector('.weather-icon');
            runner.assert(iconElement !== null, 'Should have weather icon element');
        });

        // ForecastGrid Integration Tests  
        runner.test('ForecastGrid integrates with icon service', async () => {
            const { ForecastGrid } = await import('../js/components/forecast.js');
            
            const container = document.createElement('div');
            const forecastGrid = new ForecastGrid(container);
            
            const mockForecastData = [
                {
                    date: new Date('2024-01-16T12:00:00Z'),
                    minTemp: 15,
                    maxTemp: 25,
                    description: 'Sunny',
                    icon: '01d',
                    humidity: 60,
                    precipitation: 0
                },
                {
                    date: new Date('2024-01-17T12:00:00Z'),
                    minTemp: 18,
                    maxTemp: 28,
                    description: 'Partly Cloudy',
                    icon: '02d',
                    humidity: 55,
                    precipitation: 10
                }
            ];
            
            forecastGrid.render(mockForecastData);
            
            const iconElements = container.querySelectorAll('.weather-icon');
            runner.assert(iconElements.length >= 2, 'Should have multiple forecast icons');
        });

        // CSS Component Tests
        runner.test('Weather icon CSS classes are defined', () => {
            const testElement = document.createElement('img');
            testElement.className = 'weather-icon';
            document.body.appendChild(testElement);
            
            const styles = getComputedStyle(testElement);
            runner.assert(styles.getPropertyValue('display') !== '', 'Weather icon should have display property');
            runner.assert(styles.getPropertyValue('width') !== '', 'Weather icon should have width');
            
            document.body.removeChild(testElement);
        });

        runner.test('Icon size variants work correctly', () => {
            const sizes = ['small', 'medium', 'large', 'xlarge'];
            
            sizes.forEach(size => {
                const testElement = document.createElement('img');
                testElement.className = `weather-icon weather-icon--${size}`;
                document.body.appendChild(testElement);
                
                const styles = getComputedStyle(testElement);
                const width = parseInt(styles.getPropertyValue('width'));
                
                runner.assert(width > 0, `Icon size ${size} should have valid width`);
                
                document.body.removeChild(testElement);
            });
        });

        runner.test('Animated icon classes work', () => {
            const testElement = document.createElement('div');
            testElement.className = 'weather-icon weather-icon--animated';
            document.body.appendChild(testElement);
            
            const styles = getComputedStyle(testElement);
            const animation = styles.getPropertyValue('animation');
            
            runner.assert(animation !== 'none' && animation !== '', 'Animated icon should have animation property');
            
            document.body.removeChild(testElement);
        });

        // Performance Tests
        runner.test('Multiple icons load efficiently', async () => {
            const module = await import('../js/services/weatherIconService.js');
            const WeatherIconService = module.WeatherIconService || module.default;
            const iconService = new WeatherIconService();
            
            const startTime = performance.now();
            
            const iconCodes = ['01d', '01n', '02d', '02n', '03d', '04d', '09d', '10d', '11d', '13d'];
            const promises = iconCodes.map(code => 
                iconService.loadIcon(document.createElement('div'), code, `Icon ${code}`)
            );
            
            await Promise.all(promises);
            
            const endTime = performance.now();
            const duration = endTime - startTime;
            
            runner.assert(duration < 5000, `All icons should load within 5 seconds (took ${duration}ms)`);
        });

        // Setup visual demonstrations
        function setupIconDemo() {
            const iconDemo = document.getElementById('icon-demo');
            
            import('../js/services/weatherIconService.js').then(async (module) => {
                const WeatherIconService = module.WeatherIconService || module.default;
                const iconService = new WeatherIconService();
                
                const iconData = [
                    { code: '01d', desc: 'Clear Day' },
                    { code: '01n', desc: 'Clear Night' },
                    { code: '02d', desc: 'Few Clouds' },
                    { code: '03d', desc: 'Scattered Clouds' },
                    { code: '04d', desc: 'Broken Clouds' },
                    { code: '09d', desc: 'Shower Rain' },
                    { code: '10d', desc: 'Rain' },
                    { code: '11d', desc: 'Thunderstorm' },
                    { code: '13d', desc: 'Snow' },
                    { code: '50d', desc: 'Mist' }
                ];
                
                for (const { code, desc } of iconData) {
                    const iconDiv = document.createElement('div');
                    iconDiv.className = 'icon-test';
                    iconDiv.innerHTML = `
                        <div class="loading-test">⏳</div>
                        <div>${code}</div>
                        <div style="font-size: 10px;">${desc}</div>
                    `;
                    iconDemo.appendChild(iconDiv);
                    
                    // Load icon asynchronously
                    iconService.loadIcon(iconDiv, code, desc);
                }
            });
        }

        // Run all tests and setup demos
        runner.run().then(() => {
            setupIconDemo();
        });
    </script>
</body>
</html>