# Architecture: BAML + Anthropic Agent Skills Integration

## System Architecture Overview

This integration demonstrates a **type-safe agent framework** combining:
- **BAML**: Compile-time type safety for prompts and LLM outputs
- **Anthropic Agent Skills**: Progressive skill disclosure for complex capabilities
- **Dual Language Support**: Python and TypeScript implementations with feature parity

**Architecture Pattern**: Example-driven integration with modular skill demonstrations

## Complete File Structure

```
integrations/baml/
├── README.md                          # Main integration overview
├── .env.template                      # Environment variables template
├── .gitignore                         # Git ignore patterns
│
├── baml_src/                          # BAML source files (language-agnostic)
│   ├── clients.baml                   # Anthropic client configuration
│   ├── functions.baml                 # BAML function definitions
│   └── types.baml                     # Custom type definitions
│
├── python/                            # Python implementation
│   ├── pyproject.toml                 # Poetry configuration
│   ├── setup.py                       # Setup.py for compatibility (pattern: python-missing-setup-py)
│   ├── requirements.txt               # Pip requirements
│   ├── .env.template                  # Python-specific env template
│   │
│   ├── baml_client/                   # Generated by BAML CLI (gitignored except __init__.py)
│   │   └── __init__.py               # Generated Python client
│   │
│   ├── examples/                      # Example implementations
│   │   ├── __init__.py
│   │   ├── document_processing.py    # PDF/DOCX analysis example
│   │   ├── data_analysis.py          # Dataset analysis example
│   │   └── custom_skill.py           # Custom skill integration example
│   │
│   ├── shared/                        # Shared utilities
│   │   ├── __init__.py
│   │   ├── config.py                 # Configuration loader
│   │   └── utils.py                  # Helper functions
│   │
│   └── tests/                         # Python tests
│       ├── __init__.py
│       ├── conftest.py               # Pytest configuration
│       ├── test_document_processing.py
│       ├── test_data_analysis.py
│       ├── test_custom_skill.py
│       └── test_integration.py       # Integration tests (real API)
│
├── typescript/                        # TypeScript implementation
│   ├── package.json                   # NPM configuration
│   ├── tsconfig.json                  # TypeScript configuration
│   ├── .env.template                  # TypeScript-specific env template
│   │
│   ├── baml_client/                   # Generated by BAML CLI (gitignored except index.ts)
│   │   └── index.ts                  # Generated TypeScript client
│   │
│   ├── src/
│   │   ├── examples/                  # Example implementations
│   │   │   ├── documentProcessing.ts # PDF/DOCX analysis example
│   │   │   ├── dataAnalysis.ts       # Dataset analysis example
│   │   │   └── customSkill.ts        # Custom skill integration example
│   │   │
│   │   ├── shared/                    # Shared utilities
│   │   │   ├── config.ts             # Configuration loader
│   │   │   └── utils.ts              # Helper functions
│   │   │
│   │   └── index.ts                   # Main exports
│   │
│   └── tests/                         # TypeScript tests
│       ├── documentProcessing.test.ts
│       ├── dataAnalysis.test.ts
│       ├── customSkill.test.ts
│       └── integration.test.ts       # Integration tests (real API)
│
├── test_data/                         # Shared test data
│   ├── sample.pdf                     # Sample PDF for testing
│   ├── sample.docx                    # Sample DOCX for testing
│   └── sample.csv                     # Sample CSV for testing
│
└── docs/                              # Documentation
    ├── SETUP.md                       # Detailed setup instructions
    ├── EXAMPLES.md                    # Example walkthroughs
    ├── BEST_PRACTICES.md              # Production best practices
    └── TROUBLESHOOTING.md             # Common issues and solutions
```

## Module Specifications

### 1. BAML Source Files (baml_src/)

#### clients.baml
```baml
// Anthropic client with Agent Skills support
client<llm> AnthropicClient {
  provider anthropic
  options {
    model "claude-3-5-sonnet-20241022"
    api_key env.ANTHROPIC_API_KEY
    // Agent Skills configuration
    max_tokens 4096
    temperature 0.7
  }
}
```

#### functions.baml
```baml
// Document Processing Function
function AnalyzeDocument(file_path: string, questions: string[]) -> DocumentAnalysis {
  client AnthropicClient
  prompt #"
    You are a document analysis assistant with access to document processing skills.

    Analyze the document at: {{ file_path }}
    Answer these questions: {{ questions }}

    Use your document processing skills to extract structured information.
  "#
}

// Data Analysis Function
function AnalyzeDataset(data_source: string, analysis_type: string) -> DataInsights {
  client AnthropicClient
  prompt #"
    You are a data analysis assistant with access to data processing skills.

    Analyze the dataset: {{ data_source }}
    Analysis type: {{ analysis_type }}

    Use your data processing skills to generate insights.
  "#
}

// Custom Skill Function
function ProcessWithCustomSkill(task: string, skill_name: string) -> SkillResult {
  client AnthropicClient
  prompt #"
    You are an agent with access to custom skills.

    Task: {{ task }}
    Available skill: {{ skill_name }}

    Use the appropriate skill to complete this task.
  "#
}
```

#### types.baml
```baml
// Document Analysis Result
class DocumentAnalysis {
  summary string
  key_findings string[]
  answers map<string, string>
  confidence_score float
}

// Data Insights Result
class DataInsights {
  trends string[]
  anomalies string[]
  recommendations string[]
  visualizations map<string, string>
}

// Skill Execution Result
class SkillResult {
  skill_used string
  output string
  metadata map<string, string>
  success bool
}
```

### 2. Python Implementation

#### Core Architecture
- **Async/await pattern** throughout (Anthropic SDK is async)
- **Type hints** on all functions (Python 3.10+ syntax)
- **Error handling** with custom exceptions
- **Logging** with structured output
- **Configuration** via environment variables

#### Key Files

**python/examples/document_processing.py**:
```python
import asyncio
from pathlib import Path
from baml_client import b  # Generated BAML client
from shared.config import load_config

async def analyze_document(file_path: str, questions: list[str]):
    """
    Analyze a document using BAML + Anthropic Agent Skills.

    Args:
        file_path: Path to PDF/DOCX file
        questions: List of questions to answer

    Returns:
        DocumentAnalysis object with structured results
    """
    try:
        # Call BAML function (type-safe)
        result = await b.AnalyzeDocument(
            file_path=file_path,
            questions=questions
        )
        return result
    except Exception as e:
        # Error handling
        raise DocumentProcessingError(f"Failed to analyze document: {e}")

if __name__ == "__main__":
    # Example usage
    result = asyncio.run(analyze_document(
        file_path="../test_data/sample.pdf",
        questions=["What are the key findings?", "What's the budget?"]
    ))
    print(f"Summary: {result.summary}")
    print(f"Findings: {result.key_findings}")
```

**python/shared/config.py**:
```python
import os from pathlib import Path
from dotenv import load_dotenv

def load_config():
    """Load configuration from environment variables."""
    # Load from .env file
    env_path = Path(__file__).parent.parent / ".env"
    load_dotenv(env_path)

    config = {
        "anthropic_api_key": os.getenv("ANTHROPIC_API_KEY"),
        "baml_log_level": os.getenv("BAML_LOG_LEVEL", "INFO"),
    }

    # Validate required config
    if not config["anthropic_api_key"]:
        raise ValueError("ANTHROPIC_API_KEY environment variable required")

    return config
```

#### Testing Strategy (Python)
- **pytest** with async support (pytest-asyncio)
- **Unit tests**: Mock BAML client responses
- **Integration tests**: Real API calls (gated by env var)
- **Fixtures**: Shared test data and mock responses

### 3. TypeScript Implementation

#### Core Architecture
- **Async/await pattern** with proper error handling
- **Strong typing** using BAML-generated types
- **ESM modules** (import/export)
- **Configuration** via dotenv
- **Error classes** for structured error handling

#### Key Files

**typescript/src/examples/documentProcessing.ts**:
```typescript
import { b } from '../baml_client';  // Generated BAML client
import { loadConfig } from '../shared/config';

export async function analyzeDocument(
  filePath: string,
  questions: string[]
): Promise<DocumentAnalysis> {
  /**
   * Analyze a document using BAML + Anthropic Agent Skills.
   *
   * @param filePath - Path to PDF/DOCX file
   * @param questions - Questions to answer
   * @returns Structured document analysis
   */
  try {
    // Call BAML function (type-safe)
    const result = await b.AnalyzeDocument({
      file_path: filePath,
      questions: questions
    });
    return result;
  } catch (error) {
    throw new DocumentProcessingError(
      `Failed to analyze document: ${error.message}`
    );
  }
}

// Example usage
if (import.meta.url === `file://${process.argv[1]}`) {
  const result = await analyzeDocument(
    '../test_data/sample.pdf',
    ['What are the key findings?', 'What\'s the budget?']
  );
  console.log(`Summary: ${result.summary}`);
  console.log(`Findings: ${result.key_findings}`);
}
```

**typescript/src/shared/config.ts**:
```typescript
import dotenv from 'dotenv';
import path from 'path';

export interface Config {
  anthropicApiKey: string;
  bamlLogLevel: string;
}

export function loadConfig(): Config {
  // Load from .env file
  dotenv.config({ path: path.join(__dirname, '../../.env') });

  const config: Config = {
    anthropicApiKey: process.env.ANTHROPIC_API_KEY || '',
    bamlLogLevel: process.env.BAML_LOG_LEVEL || 'INFO',
  };

  // Validate required config
  if (!config.anthropicApiKey) {
    throw new Error('ANTHROPIC_API_KEY environment variable required');
  }

  return config;
}
```

#### Testing Strategy (TypeScript)
- **Vitest** for testing (modern, fast, ESM-native)
- **Unit tests**: Mock BAML client with vi.mock()
- **Integration tests**: Real API calls (gated by env var)
- **Type tests**: Verify BAML-generated types are correct

### 4. Agent Skills Integration Patterns

#### Progressive Disclosure Pattern
```python
# Skills are introduced only when needed
async def smart_agent_with_skills(task: str):
    """Agent that loads skills based on task analysis."""

    # Step 1: Analyze task to determine needed skills
    task_type = await analyze_task_type(task)

    # Step 2: Load only necessary skills
    if task_type == "document_analysis":
        available_skills = ["pdf_reader", "docx_parser"]
    elif task_type == "data_analysis":
        available_skills = ["data_processor", "visualization"]
    else:
        available_skills = []

    # Step 3: Execute with appropriate skills
    result = await execute_with_skills(task, available_skills)
    return result
```

#### Error Handling Pattern
```python
# Comprehensive error handling
try:
    result = await b.AnalyzeDocument(file_path, questions)
except BAMLValidationError as e:
    # Type validation failed
    logger.error(f"Type validation failed: {e}")
    raise
except AnthropicAPIError as e:
    # API call failed
    logger.error(f"API error: {e}")
    # Retry logic
    result = await retry_with_backoff(b.AnalyzeDocument, file_path, questions)
except Exception as e:
    # Unexpected error
    logger.error(f"Unexpected error: {e}")
    raise
```

#### Streaming Pattern
```python
# Streaming responses with skills
async def stream_with_skills(task: str):
    """Stream responses with real-time skill invocations."""

    async for chunk in b.ProcessWithCustomSkill.stream(task=task, skill_name="analyzer"):
        # Handle partial results
        if chunk.partial_result:
            yield chunk.partial_result

        # Handle skill invocations
        if chunk.skill_invocation:
            logger.info(f"Skill invoked: {chunk.skill_invocation.skill_name}")
```

## Implementation Steps (Ordered)

### Phase 1: Project Setup
1. Create directory structure
2. Initialize Python project (pyproject.toml, setup.py)
3. Initialize TypeScript project (package.json, tsconfig.json)
4. Create .gitignore (exclude baml_client/ generated code)
5. Create .env.template files

### Phase 2: BAML Configuration
6. Create baml_src/clients.baml (Anthropic client)
7. Create baml_src/types.baml (custom types)
8. Create baml_src/functions.baml (3 functions)
9. Generate client code (baml-cli generate)

### Phase 3: Python Implementation
10. Implement shared/config.py
11. Implement shared/utils.py
12. Implement examples/document_processing.py
13. Implement examples/data_analysis.py
14. Implement examples/custom_skill.py
15. Create test files with mocks

### Phase 4: TypeScript Implementation
16. Implement shared/config.ts
17. Implement shared/utils.ts
18. Implement examples/documentProcessing.ts
19. Implement examples/dataAnalysis.ts
20. Implement examples/customSkill.ts
21. Create test files with mocks

### Phase 5: Test Data
22. Create sample.pdf (simple test document)
23. Create sample.docx (simple test document)
24. Create sample.csv (simple test dataset)

### Phase 6: Documentation
25. Create README.md (overview, quickstart)
26. Create docs/SETUP.md (detailed setup)
27. Create docs/EXAMPLES.md (example walkthroughs)
28. Create docs/BEST_PRACTICES.md (production tips)
29. Create docs/TROUBLESHOOTING.md (common issues)

### Phase 7: Integration
30. Update Context Foundry main README
31. Create integration tests
32. Verify both Python and TypeScript examples work

## Testing Requirements and Procedures

### Unit Tests

**Python (pytest)**:
```bash
cd python/
pytest tests/ -v --cov=examples --cov=shared
```

Expected: All tests pass, >80% coverage

**TypeScript (Vitest)**:
```bash
cd typescript/
npm test
```

Expected: All tests pass, >80% coverage

### Integration Tests

**Prerequisites**:
- Set ANTHROPIC_API_KEY in .env
- Set RUN_INTEGRATION_TESTS=true

**Python**:
```bash
cd python/
pytest tests/test_integration.py -v
```

**TypeScript**:
```bash
cd typescript/
npm run test:integration
```

**Success Criteria**:
- All BAML functions execute without errors
- Type validation passes
- Results match expected schema
- No API errors (except rate limits)

### E2E Tests (Critical per pattern library)

**Pattern ID**: e2e-testing-spa-real-browser (adapted for API integration)

**Python E2E Test**:
```python
# tests/test_e2e.py
async def test_full_document_workflow():
    """End-to-end test with real API call."""
    # Load real test document
    file_path = "../test_data/sample.pdf"
    questions = ["What is the main topic?"]

    # Execute with real API
    result = await analyze_document(file_path, questions)

    # Verify structure
    assert result.summary is not None
    assert len(result.key_findings) > 0
    assert len(result.answers) == len(questions)

    # Verify types (BAML should ensure this)
    assert isinstance(result.confidence_score, float)
    assert 0 <= result.confidence_score <= 1
```

**Why This is Critical**:
- Unit tests with mocks don't catch: API errors, type mismatches, skill loading issues
- Integration tests catch 80% of production bugs (pattern library evidence)
- BAML type safety helps, but doesn't guarantee API compatibility

### Test Success Criteria

✅ **Unit tests**: All pass, >80% coverage
✅ **Integration tests**: All pass with real API
✅ **E2E tests**: Full workflows work end-to-end
✅ **Type safety**: BAML-generated types compile without errors
✅ **Error handling**: Graceful failures with clear messages
✅ **Documentation**: All examples run successfully

## Success Criteria

### Functional Requirements
- ✅ BAML client configuration works with Anthropic API
- ✅ All 3 example functions execute successfully
- ✅ Python and TypeScript implementations have feature parity
- ✅ Type-safe prompts with compile-time validation
- ✅ Error handling for all failure modes
- ✅ Streaming support demonstrated
- ✅ Progressive disclosure pattern implemented

### Quality Requirements
- ✅ Production-ready code (error handling, logging, typing)
- ✅ Comprehensive documentation (4 docs minimum)
- ✅ Test coverage >80%
- ✅ Security best practices (no API keys in code)
- ✅ Easy setup (<5 minutes for developers)

### Integration Requirements
- ✅ Integrated into Context Foundry structure
- ✅ Main README updated
- ✅ Works alongside existing features
- ✅ Clear contribution path

## Applied Patterns from Pattern Library

### Pattern: python-missing-setup-py
**Applied**: Include both pyproject.toml AND setup.py for Python project
**Why**: Ensures editable install compatibility across environments

### Pattern: e2e-testing-spa-real-browser
**Adapted**: E2E tests with real API calls (not mocked)
**Why**: Unit tests don't catch integration issues with external APIs

### Pattern: typescript-express-types-tsnode
**Applied**: Proper TypeScript configuration with strict type checking
**Why**: Prevents runtime type errors in TypeScript implementation

## Preventive Measures

### Security
- ✅ No API keys in code or git history
- ✅ .env files in .gitignore
- ✅ .env.template for documentation
- ✅ Clear setup instructions for API key configuration

### Reliability
- ✅ Retry logic with exponential backoff
- ✅ Rate limit handling
- ✅ Clear error messages
- ✅ Logging for debugging

### Maintainability
- ✅ Clear module boundaries
- ✅ Comprehensive inline comments
- ✅ Type hints/annotations throughout
- ✅ Consistent code style (Black for Python, Prettier for TypeScript)

---

**Architecture Complete**
**Status**: READY FOR BUILD PLANNING
**Complexity**: Medium-High (dual language, new integration)
**Estimated Build Time**: 2-3 hours
